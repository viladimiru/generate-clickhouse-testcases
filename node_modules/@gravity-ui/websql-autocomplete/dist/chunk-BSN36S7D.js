import{a as u}from"./chunk-2HA4XQFN.js";import{CharStream as O,CommonTokenStream as K}from"antlr4ng";var j=/[\w]$/,b=/\r\n|\n|\r/g;function A(e,n){let r=e.column,s=e.column+(e.text?.length||0),t=e.line,o=e.type!==n||!e.text?t:t+(e.text.match(b)?.length||0);return{startColumn:r,startLine:t,endColumn:s,endLine:o}}u(A,"getTokenPosition");function I(e,n,r,s){let t=n.column-1;for(let o=0;o<e.size;o++){let i=e.get(o),{startColumn:l,startLine:a,endColumn:d,endLine:m}=A(i,r);if(m>n.line||a===n.line&&d>t)return s?o:o>0&&a===n.line&&l===t&&j.test(e.get(o-1).text||"")?o-1:e.get(o).type===r?o+1:o}}u(I,"findCursorTokenIndex");function N(e,n){let r=e.split(b),s=e.match(b),t="";s&&(t=s[0]);let o=0;return r.reduce((i,l,a)=>(n.line-1===a&&(i.length?o=i.length+n.column:o=n.column-1),a===0?l:i+t+l),""),o}u(N,"getCursorIndex");function H(e,n){return e===n.startTokenIndex}u(H,"isStartingToWriteRule");function M(e,n){let r=e.slice(0,n-1),s=e.slice(n-1),t=r.lastIndexOf(";"),o=s.indexOf(";"),i=t>-1?t+1:0,l=o>-1?o+r.length:e.length,a=e.slice(i,l),d=n-i;return{statement:a,cursorIndex:d}}u(M,"getCurrentStatement");var h=`(\\s|\r
|
|\r)+`,z=new RegExp(`^(${h})?explain${h}$`),_=new RegExp(`^(${h})?\\S+${h}`);function te(e,n){let r=N(e,n),s=M(e,r),t=s.statement.slice(0,s.cursorIndex).toLowerCase();return!!(r===0||!t.match(_)||t.match(z))}u(te,"shouldSuggestTemplates");function p(e,n,r){let s=O.fromString(r),t=new e(s),o=new K(t),i=new n(o);return i.removeErrorListeners(),i}u(p,"createParser");function ne(e,n){let r=O.fromString(n);return new e(r)}u(ne,"createLexer");var P=class{static{u(this,"SqlErrorListener")}constructor(n){this.errors=[],this.whitespaceToken=n}syntaxError(n,r,s,t,o){if(r){let i=A(r,this.whitespaceToken);this.errors.push({message:o,...i})}else this.errors.push({message:o,startLine:s,startColumn:t,endLine:s,endColumn:t})}reportAmbiguity(){}reportAttemptingFullContext(){}reportContextSensitivity(){}};import*as B from"antlr4-c3";function fe(e,n,r,s,t){let o=p(e,n,t),i=new P(r);return o.removeErrorListeners(),o.addErrorListener(i),s(o),{errors:i.errors}}u(fe,"parseQueryWithoutCursor");var D=/^'(.*)'$/;function pe(e,n,r,s,t,o,i,l,a,d){let m=p(e,n,l),{tokenStream:c}=m,y=new P(r);m.removeErrorListeners(),m.addErrorListener(y),o(m);let g=new B.CodeCompletionCore(m);g.ignoredTokens=s,g.preferredRules=t;let x=I(c,a,r);if(x===void 0)throw new Error(`Could not find cursor token index for line: ${a.line}, column: ${a.column}`);let T=[],{tokens:S,rules:f}=g.collectCandidates(x,d);S.forEach((L,E)=>{let Q=m.vocabulary.getLiteralName(E)?.replace(D,"$1")||m.vocabulary.getSymbolicName(E);if(!Q)throw new Error(`Could not get name for token ${E}`);T.push({value:Q})});let C={errors:y.errors,suggestKeywords:T};return i(C,f,c,x,a,l)}u(pe,"parseQuery");function Ce(e){let n=e.split(b),r="|",s;for(let c=0;c<n.length;c++)if(n[c]?.includes(r)){s=c;break}if(s===void 0)throw new Error(`Cursor not provided for query ${e}`);let t=n[s];if(!t)throw new Error(`Line ${s} not found`);let[o,i,...l]=e.split(r),[a,d,...m]=t.split(r);if(l.length>0||m.length>0)throw new Error(`Multiple cursors not allowed, but present in query ${e}`);if(o===void 0||i===void 0||a===void 0||d===void 0)throw new Error(`Cursor not provided for query ${e}`);return[o+i,{line:s+1,column:a.length+1}]}u(Ce,"separateQueryAndCursor");import*as k from"antlr4-c3";var R=class extends k.TypedSymbol{static{u(this,"TableSymbol")}constructor(n,r,s){super(n,s),this.name=n,this.alias=r}};function F(e=[]){let n=e.reduce((r,s)=>{let t=r[s.name]??new Set;return s.alias&&t.add(s.alias),r[s.name]=t,r},{});return Object.keys(n).reduce((r,s)=>{let t=n[s];return t.size>0?t?.forEach(o=>{r.push({name:s,alias:o})}):r.push({name:s}),r},[])}u(F,"getUniqueTableSuggestions");function v(e){let n=e.symbolTable.getNestedSymbolsOfTypeSync(R);return F(n)}u(v,"getTablesFromSymbolTable");var w=class extends k.TypedSymbol{static{u(this,"ColumnAliasSymbol")}constructor(n,r){super(n,r),this.name=n}};function $(e){return e.symbolTable.getNestedSymbolsOfTypeSync(w).map(({name:n})=>({name:n}))}u($,"getColumnAliasesFromSymbolTable");function J(e,n,r){let s=n;for(;s<e.size;){let o=e.get(s);if(o.type===r.CLOSING_BRACKET||o.type===r.SEMICOLON)return{cursorIndex:o.start,tokenIndex:s};if(o.type===r.OPENING_BRACKET)return;s++}let t=e.size-1;return{cursorIndex:e.get(t).start,tokenIndex:t}}u(J,"getClosingBracketIndex");function U(e,n,r){let s=e.get(e.size-1).start,t=n,o=!1;for(;t>=0&&t<e.size;){let i=e.get(t);if(i.type===r.OPENING_BRACKET||i.type===r.CLOSING_BRACKET||i.type===r.SEMICOLON){if(o)break;t=n,o=!0}if(i.type===r.FROM){let l=J(e,n,r);if(!l)break;let a=W(e,t,l.tokenIndex,r),d=a?{start:a,end:l.cursorIndex}:void 0,m=G(e,r,l.tokenIndex,r.SELECT),c=m?{start:m.start,end:l.cursorIndex}:void 0;return{start:i.start,end:l.cursorIndex,type:"from",joinTableQueryPosition:d,selectTableQueryPosition:c}}o?t++:t--,t===-1&&(t=n,o=!0)}for(t=n;t>=0;){let i=e.get(t);if(i.type===r.SEMICOLON)return;if(i.type===r.ALTER&&!!!G(e,r,t,r.ALTER))return{start:i.start,end:s,type:"alter"};if(i.type===r.INSERT)return{start:i.start,end:s,type:"insert"};if(i.type===r.UPDATE)return{start:i.start,end:s,type:"update"};t--}}u(U,"getTableQueryPosition");function W(e,n,r,s){let t=n;for(;t<r;){let o=e.get(t);if(o.type===s.JOIN)return o.stop+1;t++}}u(W,"getJoinIndex");function G(e,n,r,s){let t=r-1;for(;t>-1;){let o=e.get(t);if(o.type===n.SEMICOLON)return;if(o.type===s)return o;t--}}u(G,"getPreviousToken");function Ee(e,n,r,s,t,o,i,l,a){let d=I(o,i,s.SPACE,!0);if(!d)throw new Error(`Could not find actualCursorTokenIndex at Ln ${i.line}, Col ${i.column}`);let m={},c=U(o,d,s);if(c){let y=l.slice(c.start,c.end),g=p(e,n,y),x=t(g,c.type);if(r.visit(x),a&&c.joinTableQueryPosition){let f=l.slice(c.joinTableQueryPosition.start,c.joinTableQueryPosition.end),C=p(e,n,f),L=t(C,"from");r.visit(L)}if(c.selectTableQueryPosition){let f=l.slice(c.selectTableQueryPosition.start,c.selectTableQueryPosition.end),C=p(e,n,f),L=t(C,"select");r.visit(L)}let T=v(r);T.length&&(m.tableContextSuggestion={tables:T});let S=$(r);S.length&&(m.suggestColumnAliases=S.map(({name:f})=>({name:f})))}return m}u(Ee,"getContextSuggestions");export{R as a,w as b,H as c,te as d,ne as e,G as f,Ee as g,P as h,fe as i,pe as j,Ce as k};
